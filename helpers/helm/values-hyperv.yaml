# Values for deploying Hyper-V mutating webhook
# Usage: helm install hyperv-webhook ./helm -f values-hyperv.yaml
#
# Override registry and version via environment variables:
#   helm install hyperv-webhook ./helm -f values-hyperv.yaml \
#     --set deployment.image.registry=$REGISTRY \
#     --set deployment.image.tag=$VERSION

webhookType: hyperv

deployment:
  image:
    # TODO: Remove repository override once sigwindowstools/hyperv-webhook image
    # is built and pushed to the registry via the webhook-build GitHub Action.
    # The default convention is {registry}/{webhookType}-webhook (sigwindowstools/hyperv-webhook),
    # but only the old image name exists in the registry for now.
    repository: sigwindowstools/hyperv-runtimeclass-mutating-webhook
    tag: ""  # Uses chart appVersion by default, override with --set deployment.image.tag=$VERSION

  # controller-runtime manages TLS and flags internally, no args needed
  args: []

  # controller-runtime default cert directory
  certMountPath: /tmp/k8s-webhook-server/serving-certs

  service:
    # TODO: Change to 8443 once the new image is built with the updated port.
    # The old image uses controller-runtime's default port 9443.
    targetPort: 9443

  # controller-runtime serves health checks on a separate HTTP port
  livenessProbe:
    httpGet:
      path: /healthz
      port: 8081
      scheme: HTTP
    initialDelaySeconds: 15
    periodSeconds: 20
    timeoutSeconds: 1
    successThreshold: 1
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /readyz
      port: 8081
      scheme: HTTP
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 1
    successThreshold: 1
    failureThreshold: 3

webhookConfiguration:
  # TODO: Change to /mutate once the new image is built with the updated path.
  # The old image uses controller-runtime's kubebuilder default /mutate-v1-pod.
  path: /mutate-v1-pod
  objectSelector:
    matchLabels:
      hyperv-isolation: "true"

# RuntimeClass configuration for Hyper-V
runtimeClass:
  enabled: true
  name: runhcs-wcow-hypervisor
  handler: runhcs-wcow-hypervisor

# Hyper-V specific configuration
hypervConfig:
  # Default Hyper-V isolation settings
  runtimeClassName: runhcs-wcow-hypervisor
  
  # CPU and memory limits for Hyper-V isolated containers
  defaultResources:
    cpuLimit: "1000m"
    memoryLimit: "2Gi"
  
  # Enable automatic resource adjustment
  autoAdjustResources: true
